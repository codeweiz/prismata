# Prismata - 多IDE AI辅助插件架构

## 项目概述

Prismata是一个支持多IDE平台的AI辅助插件系统，旨在为开发者提供代码理解、文件操作和代码生成等AI能力。该项目的核心目标是实现一个可在VSCode和JetBrains IDEA等多个IDE环境中复用的AI Agent架构。

## 核心功能需求

### 基础功能

1. **文件操作**
   - 读取指定文件内容
   - 写入或修改指定文件内容
   - 安全的文件操作机制（防止误写、误删）

2. **代码库分析**
   - 对代码库进行结构化分析
   - 理解代码上下文和依赖关系
   - 提取代码语义信息

3. **多步Agent任务**
   - 代码重构
   - 测试生成
   - 文档生成
   - 其他复杂的代码操作任务

## 架构设计

### 混合架构

#### 架构概述

```
┌─────────────────────┐      ┌─────────────────────┐
│                     │      │                     │
│  IDE插件            │      │  IDE插件            │
│  (VSCode)           │      │  (JetBrains)        │
│                     │      │                     │
└──────────┬──────────┘      └──────────┬──────────┘
           │                            │
           │                            │
           ▼                            ▼
┌──────────────────────────────────────────────────┐
│                                                  │
│              插件适配层 (Adapter)                │
│                                                  │
└──────────────────────┬───────────────────────────┘
                       │
                       │
                       ▼
┌──────────────────────────────────────────────────┐
│                                                  │
│              本地Agent服务 (基础功能)            │
│                                                  │
└──────────────────────┬───────────────────────────┘
                       │
                       │  可选的云端增强功能
                       ▼
┌──────────────────────────────────────────────────┐
│                                                  │
│              云端AI服务 (高级功能)               │
│                                                  │
└──────────────────────────────────────────────────┘
```

#### 优势
- 基础功能在本地运行，保证核心功能离线可用
- 资源密集型任务可选择性地使用云端服务
- 灵活的部署选项，适应不同场景需求
- 更好的隐私保护与性能平衡

#### 劣势
- 架构相对复杂
- 需要维护本地和云端两套系统
- 状态同步可能带来额外复杂性

## 通信协议

使用JSON-RPC协议实现IDE插件与Agent服务之间的通信，支持文件操作、代码分析和代码生成等核心功能。

## 项目结构

```
prismata/
├── core_agent/               # 核心AI agent功能
├── communication/            # 通信层
├── shared/                   # 共享模型和工具
├── vscode_extension/         # VSCode插件
├── jetbrains_plugin/         # JetBrains插件
├── tests/                    # 测试套件
└── docs/                     # 文档
```

## 技术选型

- **语言**: 核心Agent（Python）、VSCode插件（TypeScript）、JetBrains插件（Java/Kotlin）
- **框架**: LangChain/LangGraph用于构建Agent、VSCode和JetBrains SDK用于插件开发
- **通信**: JSON-RPC协议实现插件与Agent之间的通信

## 开发路线图

1. 核心Agent和通信协议开发
2. VSCode插件开发
3. JetBrains插件开发
4. 高级功能和优化

## 核心API

提供以下核心API类别：

- **文件操作**: 读取文件、写入文件、获取文件元数据
- **代码分析**: 结构化分析、依赖关系提取、符号查询
- **代码生成**: 根据提示生成代码、代码补全、代码重构
- **多步任务**: 测试生成、文档生成、复杂重构任务

## 插件工作流

插件工作流程包括：用户输入指令 → 解析用户意图 → 获取上下文 → 调用Agent服务 → 处理响应 → 展示结果。

对于文件修改操作，插件先生成预览，用户确认后才执行实际修改，并记录操作历史以支持回滚。

## 安全与用户控制

- **文件操作安全**: 操作预览与确认、版本控制集成、操作历史记录
- **Agent操作可见性**: 实时显示执行步骤、解释操作目的和影响
- **用户控制机制**: 暂停/继续执行、修改中间结果、操作否决权

## 安全边界

- **插件端安全**: 文件访问限制（仅当前工作区）、用户界面安全、本地存储安全
- **服务端安全**: API访问控制、数据隔离、代码执行沙箱

## Agent实现

基于LangChain/LangGraph实现多步Agent任务，包括：

- 文件操作工具（读取、写入文件）
- 代码分析工具（结构分析、依赖提取）
- 代码生成工具（函数生成、代码补全）
- 多步工作流（理解请求、分析上下文、规划变更、执行变更、验证结果）

## 实现细节

### 本地Agent服务

- **部署方式**: 独立后台进程，与IDE插件分离，通过gRPC/WebSocket通信
- **生命周期**: IDE插件管理Agent服务的启动、停止和更新，支持自动和手动模式
- **上下文共享**: 利用IDE索引和文件监听器，安全高效地共享项目信息

### 代码库分析

- **分层策略**: 结合IDE分析能力（LSP/PSI）和自主分析工具，提供结构化信息
- **LLM增强**: 将结构化分析结果作为上下文提供给LLM，增强理解能力

### 状态同步与上下文管理

- **任务分解**: 明确划分本地与云端任务边界，减少状态同步复杂性
- **多层次上下文**: 根据任务类型智能收集核心、相关和项目上下文
- **上下文优化**: 实现上下文压缩和优先级策略，平衡全面性和性能

### 云端AI服务

云端服务专注于资源密集型任务：

- **大规模生成**: 复杂代码生成、整体模块重构、完整测试套件生成
- **全局分析**: 跨文件代码分析、设计模式识别、依赖关系图生成
- **知识密集型任务**: API使用建议、技术文档生成、代码可视化

### 错误处理与回滚

- **检查点机制**: 定期保存任务中间状态，支持精细化回滚
- **渐进式恢复**: 支持从最近检查点恢复，而非完全重启
- **用户干预**: 提供详细错误报告，允许用户修改中间结果并继续执行

### 性能优化

- **异步处理**: 实现异步任务处理和实时进度反馈，避免阻塞UI
- **多级缓存**: 缓存常用分析和生成结果，减少重复计算
- **预加载与预测**: 预加载常用模型，基于用户行为预测可能的操作

### shared/目录内容

- **数据模型**: 通用DTO、领域模型、序列化工具
- **工具函数**: 路径处理、日志、加密、验证工具
- **接口定义**: 插件接口、服务接口、通信协议接口

### 测试策略

- **多层测试**: 单元测试、集成测试、端到端测试
- **AI行为测试**: 定义代码生成质量的客观指标

## 开发计划

我们制定了详细的里程碑计划，分阶段实现项目功能：

1. **里程碑 1**: 基础框架与核心通信 (2周)
2. **里程碑 2**: 基础 AI 能力 (3周)
3. **里程碑 3**: 增强的代码理解与生成 (4周)
4. **里程碑 4**: 多步骤任务与 JetBrains 支持 (5周)
5. **里程碑 5**: 高级功能与性能优化 (6周)
6. **里程碑 6**: 生产就绪与发布 (4周)

详细信息请参考 [docs/milestones.md](docs/milestones.md)。

## 贡献

我们欢迎各种形式的贡献！请查看 [CONTRIBUTING.md](CONTRIBUTING.md) 了解如何参与项目开发。

## 结论

混合架构提供了最佳的灵活性和性能平衡，适合构建跨IDE的AI辅助插件系统。建议采用LangChain/LangGraph构建代码Agent，实现严格的安全机制，并提供透明的操作可视化。
